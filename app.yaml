# Credits: https://github.com/h5bp/server-configs-gae/blob/master/app.yaml

# see: https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching
# and https://jakearchibald.com/2016/caching-best-practices/
# for more info about caching

runtime: python27
api_version: 1
threadsafe: true

instance_class: F1
automatic_scaling:
  max_concurrent_requests: 16 # (Default: 8, Maximum: 80)
  max_idle_instances: automatic # default value
  max_pending_latency: automatic
  min_idle_instances: 1
  min_pending_latency: 30ms # default value

libraries:
- name: webapp2
  version: "2.5.2"
- name: jinja2
  version: "2.6"

handlers:

# Manifest files

- url: /(.+\.webapp)
  upload: gae/(.+\.webapp)
  static_files: gae/\1
  mime_type: application/x-web-app-manifest+json
  # sets "Cache-Control" and "Expires" HTTP headers!
  expiration: "30s"
  secure: always
  http_headers:
    X-Content-Type-Options: "nosniff"
    Strict-Transport-Security: "max-age=10886400; includeSubDomains"

# Images (cached for a year since URLs contain hashes)

- url: /(.+\.ico)
  upload: gae/(.+\.ico)
  static_files: gae/\1
  expiration: "365d"
  secure: always
  http_headers:
    Content-Type: "image/x-icon"
    # Allow cross-origin access to web fonts and images
    # You can also replace "*" with a specific host, e.g. https://example.org
    Access-Control-Allow-Origin: "*"
    X-Content-Type-Options: "nosniff"
    Strict-Transport-Security: "max-age=10886400; includeSubDomains"

- url: /(.+\.(gif|jpe?g|png|svgz?|webp))
  upload: gae/(.+\.(gif|jpe?g|png|svgz?|webp))
  static_files: gae/\1
  expiration: "365d"
  secure: always
  http_headers:
    Access-Control-Allow-Origin: "*"
    X-Content-Type-Options: "nosniff"
    Strict-Transport-Security: "max-age=10886400; includeSubDomains"

# CSS, Javascript, text and other file types

- url: /sw\.js
  upload: gae/sw\.js
  static_files: gae/sw.js
  expiration: "30s"
  secure: always
  http_headers:
    X-Content-Type-Options: "nosniff"
    Content-Type: "text/javascript; charset=utf-8"
    Strict-Transport-Security: "max-age=10886400; includeSubDomains"

- url: /(.+\.js)
  upload: gae/(.+\.js)
  static_files: gae/\1
  expiration: "365d"
  secure: always
  http_headers:
    X-Content-Type-Options: "nosniff"
    Content-Type: "text/javascript; charset=utf-8"
    Strict-Transport-Security: "max-age=10886400; includeSubDomains"

- url: /(.+\.css)
  upload: gae/(.+\.css)
  static_files: gae/\1
  expiration: "365d"
  secure: always
  http_headers:
    X-Content-Type-Options: "nosniff"
    Content-Type: "text/css; charset=utf-8"
    Strict-Transport-Security: "max-age=10886400; includeSubDomains"

- url: /sitemap
  upload: gae/sitemap\.xml
  static_files: gae/sitemap.xml
  secure: always
  http_headers:
    X-Content-Type-Options: "nosniff"
    Content-Type: "text/xml; charset=utf-8"
    Strict-Transport-Security: "max-age=10886400; includeSubDomains"

- url: /manifest\.webmanifest
  upload: gae/manifest\.webmanifest
  static_files: gae/manifest.webmanifest
  secure: always
  http_headers:
    X-Content-Type-Options: "nosniff"
    Content-Type: "application/manifest+json; charset=utf-8"
    Strict-Transport-Security: "max-age=10886400; includeSubDomains"

- url: /(.+\.(xml|txt|json|map))
  upload: gae/(.+\.(xml|txt|json|map))
  static_files: gae/\1
  secure: always
  http_headers:
    X-Content-Type-Options: "nosniff"
    Strict-Transport-Security: "max-age=10886400; includeSubDomains"

# Homepages for /ar/ & /en/

- url: /(ar|en)(?:/|/index\.html)?
  upload: gae/(.+)/index\.html
  static_files: gae/\1/index.html
  secure: always
  http_headers:
    X-Frame-Options: "deny"
    X-UA-Compatible: "IE=edge"
    X-Xss-Protection: "1; mode=block"
    X-Content-Type-Options: "nosniff"
    Content-Type: "text/html; charset=utf-8"
    Strict-Transport-Security: "max-age=10886400; includeSubDomains"
    # see: https://developers.google.com/web/fundamentals/security/csp/
    # or online CSP header generator such as: http://cspisawesome.com/
    # or https://httpsecurityreport.com/best_practice.html
    Content-Security-Policy: >-
      default-src 'self';
      font-src https://fonts.gstatic.com;
      img-src 'self' https://www.google-analytics.com;
      connect-src 'self' https://bader-nasser.appspot.com;
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
      script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.google-analytics.com;


# Pretty links for courses & projects

- url: /((ar|en)/(courses|projects))(:?/|\.html)?
  upload: gae/(.+)\.html
  static_files: gae/\1.html
  application_readable: true
  secure: always
  http_headers:
    X-Frame-Options: "deny"
    X-UA-Compatible: "IE=edge"
    X-Xss-Protection: "1; mode=block"
    X-Content-Type-Options: "nosniff"
    Content-Type: "text/html; charset=utf-8"
    Strict-Transport-Security: "max-age=10886400; includeSubDomains"
    Content-Security-Policy: >-
      default-src 'self';
      font-src https://fonts.gstatic.com;
      img-src 'self' https://www.google-analytics.com;
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
      script-src 'self' 'unsafe-inline' https://www.google-analytics.com;

# Google verification HTML page

- url: /google334d7caabe96fad5\.html
  upload: gae/google334d7caabe96fad5\.html
  static_files: gae/google334d7caabe96fad5.html
  secure: always
  http_headers:
    X-Frame-Options: "deny"
    X-UA-Compatible: "IE=edge"
    X-Xss-Protection: "1; mode=block"
    X-Content-Type-Options: "nosniff"
    Content-Type: "text/html; charset=utf-8"
    Content-Security-Policy: "default-src 'none';"
    Strict-Transport-Security: "max-age=10886400; includeSubDomains"

# Redirecting & handling errors: 404 & 500

- url: /.*
  script: main.app

skip_files:
- ^(.*/)?#.*#$
- ^(.*/)?.*~$
- ^(.*/)?.*\.py[co]$
- ^(.*/)?.*/RCS/.*$
- ^(.*/)?\..*$
- ^(.*/)?.*\.bak$

- ^client-secret\.json\.enc$
- ^gulpfile.*\.js$
- ^package.*\.json$
- ^README\.md$
- ^LICENSE$
- ^webpack\.config\.js$

- ^node_modules
- ^pages
- ^app
- ^\.tmp
- ^\.vscode

- gae/(.*/)?.*\.yaml$
- gae/(index|courses|projects)\.html
- gae/rev-manifest\.json
